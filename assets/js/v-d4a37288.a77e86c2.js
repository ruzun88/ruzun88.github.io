"use strict";(self.webpackChunkruzun_docs=self.webpackChunkruzun_docs||[]).push([[674],{5257:(n,s,a)=>{a.r(s),a.d(s,{data:()=>t});const t={key:"v-d4a37288",path:"/spring/security/403-forbidden.html",title:"403 Forbidden",lang:"ko-KR",frontmatter:{lang:"ko-KR",title:"403 Forbidden",description:"Spring security에서 403이 뜰 때 확인해 보아야 할 것",tags:["spring security","Forbidden"]},excerpt:"",headers:[{level:2,title:"Config 설정 돌아보기",slug:"config-설정-돌아보기",children:[]},{level:2,title:"Filter 들여다 보기",slug:"filter-들여다-보기",children:[{level:3,title:"정리하자면,",slug:"정리하자면",children:[]}]}],filePathRelative:"spring/security/403-forbidden.md",git:{updatedTime:1634048629e3,contributors:[{name:"yongjun",email:"ruzun88@gmail.com",commits:1}]}}},8450:(n,s,a)=>{a.r(s),a.d(s,{default:()=>m});var t=a(6252),e=a(9790);const o=(0,t._)("h1",{id:"spring-security-에서-403-forbidden",tabindex:"-1"},[(0,t._)("a",{class:"header-anchor",href:"#spring-security-에서-403-forbidden","aria-hidden":"true"},"#"),(0,t.Uk)(" Spring Security 에서, 403 Forbidden")],-1),c=(0,t._)("div",{class:"custom-container tip"},[(0,t._)("p",{class:"custom-container-title"},"TIP"),(0,t._)("p",null,[(0,t.Uk)("난 잘못한게 없는데, 403이 떴다! 싶을 때, 참고하세요."),(0,t._)("br"),(0,t.Uk)(" case를 늘려가면서 추가할 예정입니다.")])],-1),l=(0,t._)("h2",{id:"config-설정-돌아보기",tabindex:"-1"},[(0,t._)("a",{class:"header-anchor",href:"#config-설정-돌아보기","aria-hidden":"true"},"#"),(0,t.Uk)(" Config 설정 돌아보기")],-1),p=(0,t._)("p",null,[(0,t.Uk)("spring security는 uri 별로 권한을 지정해 줄 수 있습니다다."),(0,t._)("br"),(0,t.Uk)(" 따라서, uri가 잘못 되었을 때나 해당 uri에 권한 지정이 잘못 되었을 때, 문제가 될 수 있습니다."),(0,t._)("br"),(0,t.Uk)(" 아래의 코드에서 예시 상황을 들어보겠습니다."),(0,t._)("br"),(0,t.Uk)(" 만약 uri가 "),(0,t._)("code",null,"/main"),(0,t.Uk)("인 화면은 권한과 상관없이 모든 사용자가 볼 수 있어야 한다고 가정해 봅시다."),(0,t._)("br"),(0,t.Uk)(" 그렇다면, "),(0,t._)("code",null,"/main"),(0,t.Uk)("은 permitAll()이 되어야 합니다. 모든 사용자가 볼 수 있어야 하니까요."),(0,t._)("br"),(0,t.Uk)(" 하지만, "),(0,t._)("code",null,"/main"),(0,t.Uk)("이라는 uri는 아래 소스에 존재하지 않지요. 따라서, "),(0,t._)("code",null,"/main"),(0,t.Uk)("은 anyRequest 조건에 걸리게 되고, "),(0,t._)("code",null,"USER"),(0,t.Uk)("가 아닌 사람들에게는 403이 뜨게 됩니다.")],-1),u=(0,t._)("div",{class:"language-java ext-java line-numbers-mode"},[(0,t._)("pre",{class:"language-java"},[(0,t._)("code",null,[(0,t._)("span",{class:"token annotation punctuation"},"@Override"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token keyword"},"protected"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"void"),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"configure"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token class-name"},"HttpSecurity"),(0,t.Uk)(" http"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"throws"),(0,t.Uk)(),(0,t._)("span",{class:"token class-name"},"Exception"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    http\n      "),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"httpBasic"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"disable"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token comment"},"// rest api 이므로 기본설정 사용안함. 기본설정은 비인증시 로그인폼 화면으로 리다이렉트 된다."),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"csrf"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"disable"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token comment"},"// rest api이므로 csrf 보안이 필요없으므로 disable처리."),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"sessionManagement"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"sessionCreationPolicy"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token class-name"},"SessionCreationPolicy"),(0,t._)("span",{class:"token punctuation"},"."),(0,t.Uk)("STATELESS"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token comment"},"// jwt token으로 인증하므로 세션은 필요없으므로 생성안함."),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"and"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n          "),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"authorizeRequests"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token comment"},"// 다음 리퀘스트에 대한 사용권한 체크"),(0,t.Uk)("\n              "),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"antMatchers"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token string"},'"/signin"'),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t._)("span",{class:"token string"},'"/signup"'),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t._)("span",{class:"token string"},'"/login"'),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"permitAll"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token comment"},"// 가입 및 인증 주소는 누구나 접근가능"),(0,t.Uk)("\n              "),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"antMatchers"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token string"},'"/test"'),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"hasAnyRole"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token string"},'"USER"'),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t._)("span",{class:"token string"},'"ADMIN"'),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n              "),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"anyRequest"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"hasRole"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token string"},'"USER"'),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token comment"},"// 그외 나머지 요청은 모두 인증된 회원만 접근 가능"),(0,t.Uk)("\n      "),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"and"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n          "),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"addFilterBefore"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token keyword"},"new"),(0,t.Uk)(),(0,t._)("span",{class:"token class-name"},"JwtAuthenticationFilter"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("jwtTokenProvider"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t._)("span",{class:"token class-name"},"UsernamePasswordAuthenticationFilter"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token keyword"},"class"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},";"),(0,t.Uk)(),(0,t._)("span",{class:"token comment"},"// jwt token 필터를 id/password 인증 필터 전에 넣는다"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n"),(0,t._)("span",{class:"token comment"},"// 소스 코드 출처: https://sybarits.github.io/2020/11/08/rest-api-security.html"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"highlight-lines"},[(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("div",{class:"highlight-line"}," "),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br")]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"8"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"9"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"10"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"11"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"12"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"13"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"14"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"15"),(0,t._)("br")])],-1),i=(0,t._)("h2",{id:"filter-들여다-보기",tabindex:"-1"},[(0,t._)("a",{class:"header-anchor",href:"#filter-들여다-보기","aria-hidden":"true"},"#"),(0,t.Uk)(" Filter 들여다 보기")],-1),_=(0,t._)("p",null,[(0,t.Uk)("위 소스코드의 마지막을 보면, "),(0,t._)("code",null,"JwtAuthenticationFilter"),(0,t.Uk)("가 Filter로 등록됩니다."),(0,t._)("br"),(0,t.Uk)(" 이 필터의 소스는 아래와 같습니다.")],-1),k=(0,t._)("div",{class:"language-java ext-java line-numbers-mode"},[(0,t._)("pre",{class:"language-java"},[(0,t._)("code",null,[(0,t._)("span",{class:"token annotation punctuation"},"@Override"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token keyword"},"public"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"void"),(0,t.Uk)(),(0,t._)("span",{class:"token function"},"doFilter"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token class-name"},"ServletRequest"),(0,t.Uk)(" request"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t._)("span",{class:"token class-name"},"ServletResponse"),(0,t.Uk)(" response"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t._)("span",{class:"token class-name"},"FilterChain"),(0,t.Uk)(" filterChain"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"throws"),(0,t.Uk)(),(0,t._)("span",{class:"token class-name"},"IOException"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t._)("span",{class:"token class-name"},"ServletException"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n        "),(0,t._)("span",{class:"token comment"},"// 토큰 정보 추출"),(0,t.Uk)("\n        "),(0,t._)("span",{class:"token class-name"},"String"),(0,t.Uk)(" token "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" jwtTokenProvider"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"resolveToken"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token class-name"},"HttpServletRequest"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(" request"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n        "),(0,t._)("span",{class:"token comment"},"// 토큰이 유효하면, 인증 정보 추출"),(0,t.Uk)("\n        "),(0,t._)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("token "),(0,t._)("span",{class:"token operator"},"!="),(0,t.Uk)(),(0,t._)("span",{class:"token keyword"},"null"),(0,t.Uk)(),(0,t._)("span",{class:"token operator"},"&&"),(0,t.Uk)(" jwtTokenProvider"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"validateToken"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("token"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t._)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n            "),(0,t._)("span",{class:"token comment"},"// 추출된 인증 정보를 필터링에 사용할 수 있도록 context에 등록"),(0,t.Uk)("\n            "),(0,t._)("span",{class:"token class-name"},"Authentication"),(0,t.Uk)(" auth "),(0,t._)("span",{class:"token operator"},"="),(0,t.Uk)(" jwtTokenProvider"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"getAuthentication"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("token"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n            "),(0,t._)("span",{class:"token class-name"},"SecurityContextHolder"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"getContext"),(0,t._)("span",{class:"token punctuation"},"("),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"setAuthentication"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("auth"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n        "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n        "),(0,t._)("span",{class:"token comment"},"// 필터링 수행"),(0,t.Uk)("\n        filterChain"),(0,t._)("span",{class:"token punctuation"},"."),(0,t._)("span",{class:"token function"},"doFilter"),(0,t._)("span",{class:"token punctuation"},"("),(0,t.Uk)("request"),(0,t._)("span",{class:"token punctuation"},","),(0,t.Uk)(" response"),(0,t._)("span",{class:"token punctuation"},")"),(0,t._)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n    "),(0,t._)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t._)("div",{class:"highlight-lines"},[(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("br"),(0,t._)("div",{class:"highlight-line"}," "),(0,t._)("br")]),(0,t._)("div",{class:"line-numbers"},[(0,t._)("span",{class:"line-number"},"1"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"2"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"3"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"4"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"5"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"6"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"7"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"8"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"9"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"10"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"11"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"12"),(0,t._)("br"),(0,t._)("span",{class:"line-number"},"13"),(0,t._)("br")])],-1),r=(0,t._)("p",null,[(0,t.Uk)("위와 같이, 토큰으로 정보를 조회하고, 인증정보를 가져온 결과는 사진과 같습니다. 디버깅 포인트는 위 코드에서 하이라이트 된 12번 line입니다. "),(0,t._)("img",{src:e,alt:"필터 디버깅 정보"}),(0,t.Uk)(" 정상적인 토큰에서 정보를 잘 추출 했고, 인증정보(authorities)를 보면 "),(0,t._)("code",null,"USER"),(0,t.Uk)("라는 권한이 잘 들어가 있습니다."),(0,t._)("br"),(0,t.Uk)(" 위 configure메서드에서 설정한 "),(0,t._)("code",null,"USER"),(0,t.Uk)("라는 권한과 토큰에서의 인증정보가 동일한 String(USER)을 가지고 있으니, 통과 될 것이라 생각 하기 쉽습니다."),(0,t._)("br"),(0,t.Uk)(" 저도 스프링 시큐리티를 처음 썼을 때, 그렇게 기대를 하고 썼다가 한참을 헤맸습니다.. ㅠㅠ"),(0,t._)("br"),(0,t.Uk)(" 스프링 시큐리티는, config에서 정의한 권한이 "),(0,t._)("code",null,"USER"),(0,t.Uk)("이면, 토큰에서 추출한 권한은 "),(0,t._)("code",null,"ROLE_USER"),(0,t.Uk)("인지 확인을 합니다."),(0,t._)("br"),(0,t.Uk)(" 즉, "),(0,t._)("code",null,"ROLE_"),(0,t.Uk)(" 접두어가 자동으로 붙는 것입니다."),(0,t._)("br"),(0,t.Uk)(" 만약 유저의 이 권한이 DB에 저장되어있다면, 이 또한 역시 "),(0,t._)("code",null,"ROLE_USER"),(0,t.Uk)("로 저장되어 있어야 합니다."),(0,t._)("br"),(0,t.Uk)(" 별도의 권한 Mapper를 통해 접두어를 바꿀 수도 있다고 합니다.")],-1),U=(0,t._)("h3",{id:"정리하자면",tabindex:"-1"},[(0,t._)("a",{class:"header-anchor",href:"#정리하자면","aria-hidden":"true"},"#"),(0,t.Uk)(" 정리하자면,")],-1),b=(0,t._)("p",null,[(0,t.Uk)("config 설정 시에는 "),(0,t._)("code",null,"ROLE_"),(0,t.Uk)("이 빠진 진짜 역할 이름을 적고, 토큰 안에 있는 정보는 "),(0,t._)("code",null,"ROLE_역할"),(0,t.Uk)(" 형태로 저장되어 있어야 합니다. DB에서 권한을 불러 온다면, DB도 "),(0,t._)("code",null,"ROLE_역할"),(0,t.Uk)("형태로 저장되어 있어야 합니다.")],-1),d={},m=(0,a(3744).Z)(d,[["render",function(n,s){return(0,t.wg)(),(0,t.iD)(t.HY,null,[o,c,l,p,u,i,_,k,r,U,b],64)}]])},3744:(n,s)=>{s.Z=(n,s)=>{for(const[a,t]of s)n[a]=t;return n}},9790:(n,s,a)=>{n.exports=a.p+"assets/img/token-debug-role-error.731e0aa6.png"}}]);