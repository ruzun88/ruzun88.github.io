"use strict";(self.webpackChunkruzun_docs=self.webpackChunkruzun_docs||[]).push([[83],{9005:(n,s,a)=>{a.r(s),a.d(s,{data:()=>e});const e={key:"v-acd05460",path:"/en/spring/security/403-forbidden.html",title:"403 Forbidden",lang:"en-US",frontmatter:{lang:"en-US",title:"403 Forbidden",description:"403 when using spring security",tags:["spring security","Forbidden"]},excerpt:"",headers:[{level:2,title:"Check Config Settings",slug:"check-config-settings",children:[]},{level:2,title:"Check Filter",slug:"check-filter",children:[{level:3,title:"In Short,",slug:"in-short",children:[]}]}],filePathRelative:"en/spring/security/403-forbidden.md",git:{updatedTime:1634137115e3,contributors:[{name:"yongjun",email:"ruzun88@gmail.com",commits:1}]}}},4464:(n,s,a)=>{a.r(s),a.d(s,{default:()=>U});var e=a(6252),t=a(9790);const o=(0,e._)("h1",{id:"_403-forbidden-with-spring-security",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#_403-forbidden-with-spring-security","aria-hidden":"true"},"#"),(0,e.Uk)(" 403 Forbidden with Spring Security")],-1),c=(0,e._)("div",{class:"custom-container tip"},[(0,e._)("p",{class:"custom-container-title"},"TIP"),(0,e._)("p",null,[(0,e.Uk)("You may think there's no wrong, but 403 Forbidden appeared."),(0,e._)("br"),(0,e.Uk)(" Don't be in panic. Check step by step!"),(0,e._)("br"),(0,e.Uk)(" I'll add other cases whenever I encounter 403.")])],-1),l=(0,e._)("h2",{id:"check-config-settings",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#check-config-settings","aria-hidden":"true"},"#"),(0,e.Uk)(" Check Config Settings")],-1),i=(0,e._)("p",null,[(0,e.Uk)("spring security can authorize for each uri."),(0,e._)("br"),(0,e.Uk)(" Therefore, if uri is wrong or misauthorized uri can be a problem."),(0,e._)("br"),(0,e.Uk)(" Here is an example."),(0,e._)("br"),(0,e.Uk)(" Assume uri "),(0,e._)("code",null,"/main"),(0,e.Uk)(" should be opened to everyone."),(0,e._)("br"),(0,e.Uk)(" Therefore, "),(0,e._)("code",null,"/main"),(0,e.Uk)(" should be "),(0,e._)("code",null,"permitAll()"),(0,e.Uk)("."),(0,e._)("br"),(0,e.Uk)(" But we cannot find the uri "),(0,e._)("code",null,"/main"),(0,e.Uk)(" in this codes below."),(0,e._)("br"),(0,e.Uk)(" Then, the uri "),(0,e._)("code",null,"/main"),(0,e.Uk)(" is belong to "),(0,e._)("code",null,"anyRequest"),(0,e.Uk)(" condition, and only "),(0,e._)("code",null,"USER"),(0,e.Uk)(" can be reached. Others will meet 403 Forbidden")],-1),u=(0,e._)("div",{class:"language-java ext-java line-numbers-mode"},[(0,e._)("pre",{class:"language-java"},[(0,e._)("code",null,[(0,e._)("span",{class:"token annotation punctuation"},"@Override"),(0,e.Uk)("\n"),(0,e._)("span",{class:"token keyword"},"protected"),(0,e.Uk)(),(0,e._)("span",{class:"token keyword"},"void"),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"configure"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token class-name"},"HttpSecurity"),(0,e.Uk)(" http"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)(),(0,e._)("span",{class:"token keyword"},"throws"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"Exception"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n    http\n      "),(0,e._)("span",{class:"token punctuation"},"."),(0,e._)("span",{class:"token function"},"httpBasic"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},"."),(0,e._)("span",{class:"token function"},"disable"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)(),(0,e._)("span",{class:"token comment"},"// diabled. rest api settings"),(0,e.Uk)("\n      "),(0,e._)("span",{class:"token punctuation"},"."),(0,e._)("span",{class:"token function"},"csrf"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},"."),(0,e._)("span",{class:"token function"},"disable"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)(),(0,e._)("span",{class:"token comment"},"// rest api. no csrf"),(0,e.Uk)("\n      "),(0,e._)("span",{class:"token punctuation"},"."),(0,e._)("span",{class:"token function"},"sessionManagement"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},"."),(0,e._)("span",{class:"token function"},"sessionCreationPolicy"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token class-name"},"SessionCreationPolicy"),(0,e._)("span",{class:"token punctuation"},"."),(0,e.Uk)("STATELESS"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)(),(0,e._)("span",{class:"token comment"},"// using jwt token, no session needed."),(0,e.Uk)("\n      "),(0,e._)("span",{class:"token punctuation"},"."),(0,e._)("span",{class:"token function"},"and"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n          "),(0,e._)("span",{class:"token punctuation"},"."),(0,e._)("span",{class:"token function"},"authorizeRequests"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)(),(0,e._)("span",{class:"token comment"},"// check for requests"),(0,e.Uk)("\n              "),(0,e._)("span",{class:"token punctuation"},"."),(0,e._)("span",{class:"token function"},"antMatchers"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token string"},'"/signin"'),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(),(0,e._)("span",{class:"token string"},'"/signup"'),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(),(0,e._)("span",{class:"token string"},'"/login"'),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},"."),(0,e._)("span",{class:"token function"},"permitAll"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)(),(0,e._)("span",{class:"token comment"},"// everyone can call this uri"),(0,e.Uk)("\n              "),(0,e._)("span",{class:"token punctuation"},"."),(0,e._)("span",{class:"token function"},"antMatchers"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token string"},'"/test"'),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},"."),(0,e._)("span",{class:"token function"},"hasAnyRole"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token string"},'"USER"'),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(),(0,e._)("span",{class:"token string"},'"ADMIN"'),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)(),(0,e._)("span",{class:"token comment"},"// only user and admin can call"),(0,e.Uk)("\n              "),(0,e._)("span",{class:"token punctuation"},"."),(0,e._)("span",{class:"token function"},"anyRequest"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},"."),(0,e._)("span",{class:"token function"},"hasRole"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token string"},'"USER"'),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)(),(0,e._)("span",{class:"token comment"},"// other requests are blocked except user"),(0,e.Uk)("\n      "),(0,e._)("span",{class:"token punctuation"},"."),(0,e._)("span",{class:"token function"},"and"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)("\n          "),(0,e._)("span",{class:"token punctuation"},"."),(0,e._)("span",{class:"token function"},"addFilterBefore"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token keyword"},"new"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"JwtAuthenticationFilter"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("jwtTokenProvider"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"UsernamePasswordAuthenticationFilter"),(0,e._)("span",{class:"token punctuation"},"."),(0,e._)("span",{class:"token keyword"},"class"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)(),(0,e._)("span",{class:"token comment"},"// jwt token Filter is added before id/password Filter"),(0,e.Uk)("\n"),(0,e._)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n"),(0,e._)("span",{class:"token comment"},"// code: https://sybarits.github.io/2020/11/08/rest-api-security.html"),(0,e.Uk)("\n")])]),(0,e._)("div",{class:"highlight-lines"},[(0,e._)("br"),(0,e._)("br"),(0,e._)("br"),(0,e._)("br"),(0,e._)("br"),(0,e._)("br"),(0,e._)("br"),(0,e._)("br"),(0,e._)("br"),(0,e._)("div",{class:"highlight-line"}," "),(0,e._)("br"),(0,e._)("br"),(0,e._)("br"),(0,e._)("br"),(0,e._)("br")]),(0,e._)("div",{class:"line-numbers"},[(0,e._)("span",{class:"line-number"},"1"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"2"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"3"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"4"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"5"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"6"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"7"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"8"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"9"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"10"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"11"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"12"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"13"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"14"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"15"),(0,e._)("br")])],-1),p=(0,e._)("h2",{id:"check-filter",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#check-filter","aria-hidden":"true"},"#"),(0,e.Uk)(" Check Filter")],-1),k=(0,e._)("p",null,[(0,e.Uk)("Look at the code above. "),(0,e._)("code",null,"JwtAuthenticationFilter"),(0,e.Uk)(" is added as Filter."),(0,e._)("br"),(0,e.Uk)(" Code lines of this filter look like this.")],-1),r=(0,e._)("div",{class:"language-java ext-java line-numbers-mode"},[(0,e._)("pre",{class:"language-java"},[(0,e._)("code",null,[(0,e._)("span",{class:"token annotation punctuation"},"@Override"),(0,e.Uk)("\n    "),(0,e._)("span",{class:"token keyword"},"public"),(0,e.Uk)(),(0,e._)("span",{class:"token keyword"},"void"),(0,e.Uk)(),(0,e._)("span",{class:"token function"},"doFilter"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token class-name"},"ServletRequest"),(0,e.Uk)(" request"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"ServletResponse"),(0,e.Uk)(" response"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"FilterChain"),(0,e.Uk)(" filterChain"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)(),(0,e._)("span",{class:"token keyword"},"throws"),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"IOException"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(),(0,e._)("span",{class:"token class-name"},"ServletException"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token comment"},"// get token info"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token class-name"},"String"),(0,e.Uk)(" token "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(" jwtTokenProvider"),(0,e._)("span",{class:"token punctuation"},"."),(0,e._)("span",{class:"token function"},"resolveToken"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token class-name"},"HttpServletRequest"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)(" request"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token comment"},"// if valid token, get auth info"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token keyword"},"if"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("token "),(0,e._)("span",{class:"token operator"},"!="),(0,e.Uk)(),(0,e._)("span",{class:"token keyword"},"null"),(0,e.Uk)(),(0,e._)("span",{class:"token operator"},"&&"),(0,e.Uk)(" jwtTokenProvider"),(0,e._)("span",{class:"token punctuation"},"."),(0,e._)("span",{class:"token function"},"validateToken"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("token"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},")"),(0,e.Uk)(),(0,e._)("span",{class:"token punctuation"},"{"),(0,e.Uk)("\n            "),(0,e._)("span",{class:"token comment"},"// add auth info to context"),(0,e.Uk)("\n            "),(0,e._)("span",{class:"token class-name"},"Authentication"),(0,e.Uk)(" auth "),(0,e._)("span",{class:"token operator"},"="),(0,e.Uk)(" jwtTokenProvider"),(0,e._)("span",{class:"token punctuation"},"."),(0,e._)("span",{class:"token function"},"getAuthentication"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("token"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n            "),(0,e._)("span",{class:"token class-name"},"SecurityContextHolder"),(0,e._)("span",{class:"token punctuation"},"."),(0,e._)("span",{class:"token function"},"getContext"),(0,e._)("span",{class:"token punctuation"},"("),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},"."),(0,e._)("span",{class:"token function"},"setAuthentication"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("auth"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n        "),(0,e._)("span",{class:"token comment"},"// do Filter"),(0,e.Uk)("\n        filterChain"),(0,e._)("span",{class:"token punctuation"},"."),(0,e._)("span",{class:"token function"},"doFilter"),(0,e._)("span",{class:"token punctuation"},"("),(0,e.Uk)("request"),(0,e._)("span",{class:"token punctuation"},","),(0,e.Uk)(" response"),(0,e._)("span",{class:"token punctuation"},")"),(0,e._)("span",{class:"token punctuation"},";"),(0,e.Uk)("\n    "),(0,e._)("span",{class:"token punctuation"},"}"),(0,e.Uk)("\n")])]),(0,e._)("div",{class:"highlight-lines"},[(0,e._)("br"),(0,e._)("br"),(0,e._)("br"),(0,e._)("br"),(0,e._)("br"),(0,e._)("br"),(0,e._)("br"),(0,e._)("br"),(0,e._)("br"),(0,e._)("br"),(0,e._)("br"),(0,e._)("div",{class:"highlight-line"}," "),(0,e._)("br")]),(0,e._)("div",{class:"line-numbers"},[(0,e._)("span",{class:"line-number"},"1"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"2"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"3"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"4"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"5"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"6"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"7"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"8"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"9"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"10"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"11"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"12"),(0,e._)("br"),(0,e._)("span",{class:"line-number"},"13"),(0,e._)("br")])],-1),_=(0,e._)("p",null,[(0,e.Uk)("The result of this code looks like this. The debugging point is on 12th line(highlighted line). "),(0,e._)("img",{src:t,alt:"Filter Debug info"}),(0,e.Uk)(" This request is authenticated from valid token, and you can see "),(0,e._)("code",null,"USER"),(0,e.Uk)(" on "),(0,e._)("code",null,"authorities"),(0,e.Uk)(" parameter."),(0,e._)("br"),(0,e._)("strong",null,"At this point, you should know something is wrong!"),(0,e._)("br"),(0,e.Uk)(" From token, "),(0,e._)("code",null,"String(USER)"),(0,e.Uk)(" role is found, and "),(0,e._)("code",null,"USER"),(0,e.Uk)(" is configured on method "),(0,e._)("code",null,"configure"),(0,e.Uk)(" above."),(0,e._)("br"),(0,e.Uk)(" It seems same, so you may think this request should be passed, but wrong."),(0,e._)("br"),(0,e.Uk)(" In Spring security, if role is "),(0,e._)("code",null,"USER"),(0,e.Uk)(" on "),(0,e._)("code",null,"configure"),(0,e.Uk)(" method, the token should have "),(0,e._)("code",null,"ROLE_USER"),(0,e.Uk)("."),(0,e._)("br"),(0,e._)("code",null,"ROLE_"),(0,e.Uk)(" prefix is needed!"),(0,e._)("br"),(0,e.Uk)(" If this role is in Database, also should be stored like "),(0,e._)("code",null,"ROLE_USER"),(0,e.Uk)("."),(0,e._)("br"),(0,e.Uk)(" You may change prefix from "),(0,e._)("code",null,"ROLE_"),(0,e.Uk)(" to other by using Auth Mapper.")],-1),d=(0,e._)("h3",{id:"in-short",tabindex:"-1"},[(0,e._)("a",{class:"header-anchor",href:"#in-short","aria-hidden":"true"},"#"),(0,e.Uk)(" In Short,")],-1),b=(0,e._)("p",null,[(0,e.Uk)("At configure method, no need to use "),(0,e._)("code",null,"ROLE_"),(0,e.Uk)(" prefix. In token, "),(0,e._)("code",null,"ROLE_"),(0,e.Uk)(" prefix is needed like "),(0,e._)("code",null,"ROLE_ADMIN"),(0,e.Uk)(". If you use database when filtering with role name, "),(0,e._)("code",null,"ROLE_"),(0,e.Uk)(" prefix is needed.")],-1),h={},U=(0,a(3744).Z)(h,[["render",function(n,s){return(0,e.wg)(),(0,e.iD)(e.HY,null,[o,c,l,i,u,p,k,r,_,d,b],64)}]])},3744:(n,s)=>{s.Z=(n,s)=>{for(const[a,e]of s)n[a]=e;return n}},9790:(n,s,a)=>{n.exports=a.p+"assets/img/token-debug-role-error.731e0aa6.png"}}]);